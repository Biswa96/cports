From 320bc67f864a68ffa6ca8ee65045777ee1d23b6f Mon Sep 17 00:00:00 2001
From: q66 <q66@chimera-linux.org>
Date: Mon, 20 Oct 2025 23:00:12 +0200
Subject: [PATCH 15/15] work around broken ecosystem hackery when bootstrapping

---
 src/bootstrap/src/core/build_steps/compile.rs | 5 ++++-
 src/bootstrap/src/lib.rs                      | 1 +
 2 files changed, 5 insertions(+), 1 deletion(-)

diff --git a/src/bootstrap/src/core/build_steps/compile.rs b/src/bootstrap/src/core/build_steps/compile.rs
index c105794fd..db415b82c 100644
--- a/src/bootstrap/src/core/build_steps/compile.rs
+++ b/src/bootstrap/src/core/build_steps/compile.rs
@@ -740,7 +740,10 @@ impl Step for StdLink {
                 let _ = fs::remove_dir_all(sysroot.join("lib/rustlib/src/rust"));
             }
 
-            builder.cp_link_r(&builder.initial_sysroot.join("lib"), &sysroot.join("lib"));
+            builder.cp_link_r(
+                &builder.initial_sysroot.join("lib/rustlib"),
+                &sysroot.join("lib/rustlib"),
+            );
         } else {
             if builder.download_rustc() {
                 // Ensure there are no CI-rustc std artifacts.
diff --git a/src/bootstrap/src/lib.rs b/src/bootstrap/src/lib.rs
index 35e369c29..c5f3cd647 100644
--- a/src/bootstrap/src/lib.rs
+++ b/src/bootstrap/src/lib.rs
@@ -450,6 +450,7 @@ impl Build {
             .run_capture_stdout(&config)
             .stdout()
             .trim()
+            .replace("lib64", "lib").replace("lib32", "lib")
             .to_owned();
 
         let initial_target_dir = Path::new(&initial_target_libdir)
-- 
2.51.1

